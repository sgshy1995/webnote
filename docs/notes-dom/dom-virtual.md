---
title: 虚拟DOM 和 DOM diff
---

## 什么是虚拟DOM

一个可以代表DOM树的对象，通常包括标签名、标签上的属性、类名、事件监听、子元素们等属性。

## 虚拟DOM的优点

### 减少不必要的DOM操作

可以减少不必要的DOM操作，提高性能。

- 可以将多次的DOM操作做合并为一次，比如一次性添加1000个元素。

- 借助 `DOM diff` 可以把多余的操作省略掉，比如添加1000个元素，但其中的990个都是重复的，相比直接 `innerHTML` 要高效。

### 可以跨平台渲染

虚拟DOM不仅可以变成真实的DOM，还可以变成小程序、Android应用、IOS应用等，因为虚拟DOM本质上是一个JS的对象。

## 虚拟DOM的缺点

- 需要额外的创建函数，比如 `React` 的 `createElement` 或者 `Vue` 的 `h`。但可以通过 `JSX` 来简化成 `XML` 的写法使用，或者用 `vue-loader` 转译模板语法。

- 严重依赖预打包工具，要添加额外的构建过程。

## 虚拟DOM和真实DOM的对比

一般来说，一个页面正常的DOM节点一般在2000-10000之间，当DOM数量比较少时，虚拟DOM可以有更高的性能；但是在数量远超常规时，虚拟DOM的对比算法可能反而会适得其反。

## DOM diff

`DOM diff` 就是虚拟DOM的对比算法（函数）。

### DOM diff 的的大概逻辑

- Tree diff

将两个DOM树逐层对比，找出那些节点需要需要更新。

如果节点是组件，就看 Component diff。

如果节点是元素，就看 Element diff。

- Component diff

如果节点是组件，先看组件类型有没有变化。

如果类型不同直接替换，删除旧的组件。

类型相同对比属性，如果属性不同则更新属性。

然后递归深入，在进行一次 Tree diff。

- Element diff

如果节点是元素，先看元素的标签名有无变化。

如果标签类型变化，则直接替换，删除旧的元素。

类型相同对比属性，如果属性不同则更新属性。

然后递归深入，在进行一次 Tree diff。

### DOM diff 的 key 问题

Vue 的 `v-for` 中的 `key` 和 React 中的元素的 `key` 都适用于 DOM diff 去对比更新DOM。

`key` 要制定唯一值，避免直接使用数组的下标，因为下标是会变的。